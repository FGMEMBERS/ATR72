<?xml version="1.0"?>
 
<!-- General cabin pressurization controller -->

<PropertyList>
	<!-- create external pressure in psi -->
	<filter>
		<type>gain</type>
		<name>create pressure in psi</name>
		<gain>1.0</gain>
		<input>
			<expression>
				<product>
					<property>systems/static/pressure-inhg</property>
					<value>0.49115420057252546</value>
				</product>
			</expression>
		</input>
		<output>
			<property>controls/pressurization/external-pressure-psi</property>
		</output>
	</filter>

	<!-- enable pressurization when airborne -->
	<logic>
		<name>pressurization required</name>
		<input>
			<and>
				<not><property>gear/gear[0]/wow</property></not>
				<not><property>gear/gear[1]/wow</property></not>
				<not><property>gear/gear[2]/wow</property></not>
			</and>
		</input>
		<output>
			<property>controls/pressurization/engaged</property>
		</output>
	</logic>
	
	<!-- disable pressurization-->
	<logic>
		<name>pressurization required</name>
		<inverted>true</inverted>
		<input>
			<or>
				<property>gear/gear[0]/wow</property>
				<property>gear/gear[1]/wow</property>
				<property>gear/gear[2]/wow</property>
			</or>
		</input>
		<output>
			<property>controls/pressurization/engaged</property>
		</output>
	</logic>

	<!-- automated descent pressurization engage -->
	<logic>
		<name>descent logic</name>
		<input>
			<and>
				<equals>
					<property>/controls/pressurization/operation-mode</property>
					<value>auto</value>
				</equals>
				<property>/controls/pressurization/engaged</property>
				<less-than>
					<property>instrumentation/gps/indicated-vertical-speed</property>
					<value>-1</value>
				</less-than>
			</and>
		</input>
		<output>
			<property>/controls/pressurization/direction</property>
			<value>descent</value>
		</output>
	</logic>

	<!-- automated ascent pressurization engage -->
	<logic>
		<name>ascent logic</name>
		<input>
			<and>
				<equals>
					<property>/controls/pressurization/operation-mode</property>
					<value>auto</value>
				</equals>
				<property>/controls/pressurization/engaged</property>
				<greater-than>
					<property>instrumentation/gps/indicated-vertical-speed</property>
					<value>1</value>
				</greater-than>
			</and>
		</input>
		<output>
			<property>/controls/pressurization/direction</property>
			<value>ascent</value>
		</output>
	</logic>
	
	<!--set that the plane is neither ascending nor descending-->
	<logic>
		<name>neither ascent nor descent</name>
		<input>
			<and>
				<equals>
					<property>/controls/pressurization/operation-mode</property>
					<value>auto</value>
				</equals>
				<property>/controls/pressurization/engaged</property>
				<less-than>
					<property>instrumentation/gps/indicated-vertical-speed</property>
					<value>1</value>
				</less-than>
				<greater-than>
					<property>instrumentation/gps/indicated-vertical-speed</property>
					<value>-1</value>
				</greater-than>
			</and>
		</input>
		<output>
			<property>/controls/pressurization/direction</property>
			<value>level</value>
		</output>
	</logic>

	<!-- calculate rate of pressurization change -->
	<filter>
		<name>determine proper rate of change</name>
		<type>gain</type>
		<gain>1.0</gain>
		<condition>
			<equal>
				<property>/controls/pressurization/operation-mode</property>
				<value>auto</value>
			</equal>
		</condition>
		<input>
			<product>
				<value>60</value>
				<property>/velocities/vertical-speed-fps</property>
			</product>
		</input>
		<output>
			<property>/controls/pressurization/temp-auto-rate-of-change-fpm</property>
		</output>
	</filter>
	
	<!-- clamp the auto descent rate based on max descent rate button -->
	<filter>
		<name>clamp rate of descent</name>
		<type>gain</type>
		<gain>1.0</gain>
		<condition>
			<and>
				<equal>
					<property>/controls/pressurization/operation-mode</property>
					<value>auto</value>
				</equal>				
				<equal>
					<property>/controls/pressurization/direction</property>
					<value>descent</value>
				</equal>
			</and>
		</condition>
		<input>
			<property>/controls/pressurization/temp-auto-rate-of-change-fpm</property>
			<min>/controls/pressurization/auto-descent-max-fpm</min>
			<max>0</max>
		</input>
		<output>
			<property>/controls/pressurization/auto-rate-of-change-fpm</property>
		</output>
	</filter>
	
	<!-- pass through the auto ascent rate without clamping -->
	<filter>
		<name>pass through auto ascent rate</name>
		<type>gain</type>
		<gain>1.0</gain>
		<condition>
			<and>
				<equal>
					<property>/controls/pressurization/operation-mode</property>
					<value>auto</value>
				</equal>				
				<equal>
					<property>/controls/pressurization/direction</property>
					<value>ascent</value>
				</equal>
			</and>
		</condition>
		<input>
			<property>/controls/pressurization/temp-auto-rate-of-change-fpm</property>
		</input>
		<output>
			<property>/controls/pressurization/auto-rate-of-change-fpm</property>
		</output>
		
	</filter>
	
	<filter>
		<name>convert manual rate of change to psi</name>
		<type>gain</type>
		<gain>1.0</gain>
		<enable>
			<condition>
				<property>/controls/pressurization/mode</property>
				<value>manual</value>
			</condition>
		</enable>
		<input>
			<!-- p = 14.7*e^(-0.21a) -->
			<product>
				<value>14.7</value>
				<pow>
					<value>2.718281828459045</value>
					<product>
						<value>-0.21</value>
						<property>/controls/pressurization/manual-rate-of-change-fpm</property>
					</product>
				</pow>
			</product>
		</input>
		<output>
			<property>/controls/pressurization/rate-of-change-psipm</property>
		</output>
	</filter>
	
	<!-- change auto rate from feet/min to psi/min -->
	<filter>
		<name>convert auto rate of change to psi</name>
		<type>gain</type>
		<gain>1.0</gain>
		<enable>
			<condition>
				<property>/controls/pressurization/mode</property>
				<value>auto</value>
			</condition>
		</enable>
		<input>
			<!-- p = 14.7*e^(-0.21a) -->
			<product>
				<value>14.7</value>
				<pow>
					<value>2.718281828459045</value>
					<product>
						<value>-0.21</value>
						<property>/controls/pressurization/auto-rate-of-change-fpm</property>
					</product>
				</pow>
			</product>
		</input>
		<output>
			<property>/controls/pressurization/rate-of-change-psipm</property>
		</output>
	</filter>
	
	<!-- adjust the cabin pressure auto mode -->
	<filter>
		<name>adjust cabin to target in auto mode ascent</name>
		<type>noise-spike</type>
		<debug>false</debug>
		<feedback-if-disabled>false</feedback-if-disabled>
		<enable>
			<condition>
				<property>/controls/pressurization/enabled</property>
			</condition>
		</enable>
		<input>
			<property>/controls/pressurization/cabin-pressure-cruise-psi</property>			
		</input>
		<output>
			<property>/controls/pressurization/temp-cabin-pressure-psi</property>
		</output>

		<max-rate-of-change>
			<expression>
				<div>
					<property>/controls/pressurization/rate-of-change-psipm</property>
					<value>60</value>
				</div>
			</expression>
		</max-rate-of-change>
    </filter>
	
	<!-- set the cabin pressure equal to external pressure when the plane is on the ground -->
	<filter>
		<type>gain</type>
		<name>set cabin pressure on ground</name>
		<gain>1.0</gain>	
		<condition>
			<not>
				<property>/controls/pressurization/engaged</property>
			</not>
		</condition>
		<input>
			<property>/controls/pressurization/external-pressure-psi</property>
		</input>
		<output>
			<property>controls/pressurization/cabin-pressure-psi</property>
			<property>controls/pressurization/temp-cabin-pressure-psi</property>
		</output>
	</filter>	
	
	<!-- set the auto landing elevation minimum pressure -->
	<filter>
		<name>set auto mode landing elevation pressure</name>
		<type>gain</type>
		<gain>1.0</gain>
		<enable>
			<condition>
				<and>
					<property>/controls/pressurization/enabled</property>
					<equals>
						<property>/controls/pressurization/operation-mode</property>
						<value>auto</value>
					</equals>
				</and>
			</condition>
		</enable>
		<input>
			<product>
				<value>14.7</value>
				<pow>
					<value>2.718281828459045</value>
					<product>
						<value>-0.21</value>
						<property>/controls/pressurization/auto-landing-elevation-ft</property>
					</product>
				</pow>
			</product>			
		</input>
		<output>
			<property>/controls/pressurization/auto-landing-elevation-psi</property>
		</output>
	</filter>

	<!-- clamp the cabin pressure in manual mode -->	
	<filter>
		<name>clamp output of the cabin pressure when in manual mode</name>
		<type>gain</type>
		<gain>1.0</gain>
		<enable>
			<condition>
				<and>
					<property>controls/pressurization/engaged</property>
					<equals>
						<property>controls/pressurization/operation-mode</property>
						<value>manual</value>
					</equals>
				</and>
			</condition>
		</enable>
		<input>
			<property>/controls/pressurization/temp-cabin-pressure-psi</property>
			<min>
				<property>/controls/pressurization/cabin-pressure-cruise-psi</property>
			</min>
			<max>15</max>		
		</input>
		<output>
			<property>/controls/pressurization/cabin-pressure-psi</property>
		</output>
	</filter>
	
	<!-- clamp the cabin pressure in auto mode -->	
	<filter>
		<name>clamp output of the cabin pressure when in auto mode</name>
		<type>gain</type>
		<gain>1.0</gain>
		<enable>
			<condition>
				<and>
					<property>controls/pressurization/engaged</property>
					<equals>
						<property>controls/pressurization/operation-mode</property>
						<value>auto</value>
					</equals>
				</and>
			</condition>
		</enable>
		<input>
			<property>/controls/pressurization/temp-cabin-pressure-psi</property>
			<min>
				<property>/controls/pressurization/cabin-pressure-cruise-psi</property>
			</min>
			<max>
				<property>/controls/pressurization/auto-landing-elevation-psi</property>
			</max>		
		</input>
		<output>
			<property>/controls/pressurization/cabin-pressure-psi</property>
		</output>
	</filter>
	
	<!-- set the pressure difference between the cabin and exterior -->
	<filter>
		<type>gain</type>
		<name>pressure difference</name>
		<gain>1.0</gain>
		<input>
			<expression>
				<abs>
					<difference>
						<property>controls/pressurization/external-pressure-psi</property>
						<property>controls/pressurization/cabin-pressure-psi</property>
					</difference>
				</abs>
			</expression>
		</input>
		<output>
			<property>controls/pressurization/pressure-difference-psi</property>
		</output>
	</filter>
	
	<!-- set the cabin altitude in ft -->
	<filter>
		<type>gain</type>
		<name>set cabin pressure in ft</name>
		<gain>1.0</gain>
		<input>
			<expression>
				<prod>
					<value>3.28</value>
					<prod>
						<value>100</value>
						<div>
							<log>
								<div>
									<property>controls/pressurization/cabin-pressure-psi</property>
									<value>14.7</value>
								</div>
							</log>
							<value>-0.012</value>
						</div>
					</prod>
				</prod>
			</expression>
		</input>
		<output>
			<property>controls/pressurization/cabin-altitude-ft</property>
		</output>
	</filter>
</PropertyList>