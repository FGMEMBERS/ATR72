<?xml version="1.0"?>
 
<!-- General cabin pressurization controller -->

<!-- TODO -->
<!-- set descent rate based on button selection -->
<!-- set current functionality to work only when auto mode -->
<!-- add manual mode -->
<!-- add pressure dump mode -->
<!-- add ditch mode -->

<PropertyList>
	<!-- create static pressure in psi -->
	<filter>
		<type>gain</type>
		<name>create pressure in psi</name>
		<gain>1.0</gain>
		<input>
			<expression>
				<product>
					<property>systems/static/pressure-inhg</property>
					<value>0.49115420057252546</value>
				</product>
			</expression>
		</input>
		<output>
			<property>systems/static/pressure-psi</property>
		</output>
	</filter>

	<!-- enable pressurization when airborne -->
	<logic>
		<name>pressurization required</name>
		<input>
			<and>
				<not><property>gear/gear[0]/wow</property></not>
				<not><property>gear/gear[1]/wow</property></not>
				<not><property>gear/gear[2]/wow</property></not>
			</and>
		</input>
		<output>
			<property>controls/pressurization/engaged</property>
		</output>
	</logic>

	<!-- set the auto landing elevation minimum pressure -->
	<filter>
		<name>set auto mode landing elevation pressure</name>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<expression>
				<prod>
					<value>14.7</value>
					<pow>
						<value>2.71828</value>
						<prod>
							<value>-0.21</value>
							<prod>
								<property>/controls/pressurization/auto-landing-elevation-ft</property>
								<value>0.000189394</value>
							</prod>
						</prod>
					</pow>					
				</prod>
			</expression>
		</input>
		<output>
			<property>/controls/pressurization/auto-landing-elevation-psi</property>
		</output>
	</filter>
	
	<!-- identify if aircraft is descending -->
	<logic>
		<name>descent logic</name>
		<input>
			<and>
				<equals>
					<property>/controls/pressurization/engaged</property>
					<value>1</value>
				</equals>
				<less-than>
					<property>instrumentation/gps/indicated-vertical-speed</property>
					<value>0</value>
				</less-than>
			</and>		
		</input>
		<output>
			<property>/controls/pressurization/descent-engaged</property>
		</output>
	</logic>
	
	<!-- identify if aircraft is ascending -->
	<logic>
		<name>descent logic</name>
		<input>
			<and>
				<equals>
					<property>/controls/pressurization/engaged</property>
					<value>1</value>
				</equals>
				<greater-than>
					<property>instrumentation/gps/indicated-vertical-speed</property>
					<value>0</value>
				</greater-than>
			</and>		
		</input>
		<output>
			<property>/controls/pressurization/ascent-engaged</property>
		</output>
	</logic>
	
	<!-- set ascent ratio -->
	<filter>
		<type>gain</type>
		<name>ascent ratio</name>
		<gain>-0.8</gain>
		<input>
			<condition>
				<property>/controls/pressurization/engaged</property>
			</condition>
			<expression>
				<div>
					<dif>
						<property>/controls/pressurization/cabin-pressure-cruise-psi</property>
						<property>/instrumentation/pressurization/cabin-pressure-psi</property>
					</dif>
					<dif>
						<property>/controls/pressurization/outside-pressure-cruise-psi</property>
						<property>/systems/static/pressure-psi</property>
					</dif>
				</div>
			</expression>
		</input>
		<input>
			<condition>
				<not><property>/controls/pressurization/engaged</property></not>
			</condition>
			<value>0</value>
		</input>
		<output>
			<property>/controls/pressurization/ascent-ratio</property>
		</output>
		<min>-0.3</min>
		<max>0</max>
	</filter>
	
	<!-- set descent ratio -->
	<filter>
		<type>gain</type>
		<name>descent ratio</name>
		<gain>0.8</gain>
		<input>
			<condition>
				<property>/controls/pressurization/engaged</property>
			</condition>
			<expression>
				<div>
					<dif>
						<property>/controls/pressurization/auto-landing-elevation-psi</property>
						<property>/instrumentation/pressurization/cabin-pressure-psi</property>
					</dif>
					<dif>
						<property>/controls/pressurization/auto-landing-elevation-psi</property>
						<property>/systems/static/pressure-psi</property>
					</dif>
				</div>
			</expression>
		</input>
		<input>
			<condition>
				<not><property>/controls/pressurization/engaged</property></not>
			</condition>
			<value>0</value>
		</input>
		<output>
			<property>/controls/pressurization/descent-ratio</property>
		</output>
		<min>0</min>
		<max>0.3</max>		
	</filter>

	<!-- calculate descent target -->
	<filter>
		<type>gain</type>
		<gain>1.0</gain>
		<name>descent target calc</name>
		<enable>
			<condition>
				<and>
					<property>/controls/pressurization/descent-engaged</property>
					<property>/controls/pressurization/engaged</property>
				</and>
			</condition>
		</enable>
		<input>
			<expression>
				<sum>
					<property>/instrumentation/pressurization/cabin-pressure-psi</property>
					<property>/controls/pressurization/descent-ratio</property>
				</sum>
			</expression>
		</input>
		<output>
			<property>instrumentation/pressurization/temp-target-cabin-pressure-psi</property>
			<min>
				<property>controls/pressurization/cabin-pressure-cruise-psi</property>
			</min>
			<max>
				<property>controls/pressurization/auto-landing-elevation-psi</property>
			</max>
		</output>
	</filter>
	
	<!-- calculate ascent target -->
	<filter>
		<type>gain</type>
		<gain>1.0</gain>
		<name>ascent target calc</name>
		<enable>
			<condition>
				<and>
					<property>/controls/pressurization/ascent-engaged</property>
					<property>/controls/pressurization/engaged</property>
				</and>
			</condition>
		</enable>
		<input>
			<expression>
				<sum>
					<property>/instrumentation/pressurization/cabin-pressure-psi</property>
					<property>/controls/pressurization/ascent-ratio</property>
				</sum>
			</expression>
		</input>
		<output>
			<property>instrumentation/pressurization/temp-target-cabin-pressure-psi</property>
			<min>
				<property>controls/pressurization/cabin-pressure-cruise-psi</property>
			</min>
			<max>
				<property>controls/pressurization/auto-landing-elevation-psi</property>
			</max>
		</output>
	</filter>	

	<!-- adjust temp target to target -->
	<filter>
		<name>adjust temp target to target</name>
		<type>noise-spike</type>
		<debug>false</debug>
		<feedback-if-disabled>false</feedback-if-disabled>
		<enable>
			<condition>
				<and>
					<property>/controls/pressurization/engaged</property>
					<or>
						<property>/controls/pressurization/ascent-engaged</property>
						<property>/controls/pressurization/descent-engaged</property>
					</or>
				</and>
			</condition>
		</enable>
		<input>/instrumentation/pressurization/temp-target-cabin-pressure-psi</input>
		<output>
			<property>/instrumentation/pressurization/target-cabin-pressure-psi</property>
		</output>
		<max-rate-of-change>0.025</max-rate-of-change>
	</filter>
	
	<!-- adjust cabin pressure towards target pressure -->
	<filter>
		<name>adjust cabin to target</name>
		<type>noise-spike</type>
		<debug>false</debug>
		<feedback-if-disabled>false</feedback-if-disabled>
		<enable>
			<condition>
				<and>
					<property>/controls/pressurization/engaged</property>
					<or>
						<property>/controls/pressurization/ascent-engaged</property>
						<property>/controls/pressurization/descent-engaged</property>
					</or>
				</and>
			</condition>
		</enable>
		<input>/instrumentation/pressurization/target-cabin-pressure-psi</input>
		<output>
			<property>/instrumentation/pressurization/cabin-pressure-psi</property>
			<min>
				<value>11.1</value>
			</min>
			<max>
				<value>15.0</value>
			</max>
		</output>
		<!--<max-rate-of-change>0.0028</max-rate-of-change>-->
		<max-rate-of-change>0.0133</max-rate-of-change>
	</filter>
	
	<!-- calculate rate of change -->
	<filter>
		<name>cabin pressure rate computer</name>
		<debug>false</debug>
		<type>derivative</type>
		<input>/instrumentation/pressurization/cabin-altitude-ft</input>
		<output>/instrumentation/pressurization/cabin-altitude-ft-sec</output>
		<filter-time>1.0</filter-time>
	</filter>
	
	<!-- convert rate of change to ft per minute -->
	<filter>
		<name>convert rate of change to ft per minute</name>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<expression>
				<prod>
					<property>/instrumentation/pressurization/cabin-altitude-ft-sec</property>
					<value>60</value>
				</prod>
			</expression>
		</input>
		<output>/instrumentation/pressurization/cabin-altitude-ft-min</output>
	</filter>
	
	<!-- set the cabin pressure equal to external pressure when the plane is on the ground -->
	<filter>
		<type>gain</type>
		<name>set cabin pressure on ground</name>
		<gain>1.0</gain>	
		<enable>
			<condition>
				<not>
					<property>/controls/pressurization/engaged</property>
				</not>
			</condition>
		</enable>
		<input>
			<property>/systems/static/pressure-psi</property>
		</input>
		<output>
			<property>instrumentation/pressurization/cabin-pressure-psi</property>
		</output>
	</filter>
	
	<!-- set the pressure difference between the cabin and exterior -->
	<filter>
		<type>gain</type>
		<name>pressure difference</name>
		<gain>1.0</gain>
		<input>
			<expression>
				<abs>
					<difference>
						<property>/systems/static/pressure-psi</property>
						<property>/instrumentation/pressurization/cabin-pressure-psi</property>
					</difference>
				</abs>
			</expression>
		</input>
		<output>
			<property>/instrumentation/pressurization/pressure-difference-psi</property>
			<property>/instrumentation/pressurization/pressure-difference-psi</property>
		</output>
	</filter>
	
	<!-- set the cabin altitude in ft -->
	<filter>
		<type>gain</type>
		<name>set cabin pressure in ft</name>
		<gain>1.0</gain>
		<input>
			<expression>
				<prod>
					<value>3.28</value>
					<prod>
						<value>100</value>
						<div>
							<log>
								<div>
									<property>/instrumentation/pressurization/cabin-pressure-psi</property>
									<value>14.7</value>
								</div>
							</log>
							<value>-0.012</value>
						</div>
					</prod>
				</prod>
			</expression>
		</input>
		<output>
			<property>/instrumentation/pressurization/cabin-altitude-ft</property>
		</output>
	</filter>

</PropertyList>